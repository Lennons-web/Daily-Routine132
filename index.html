<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Bliss Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --weekday: #6366f1;   /* Indigo */
      --weekend: #f59e0b;   /* Amber */
      --holiday: #06b6d4;   /* Cyan */
    }
    body { transition: background 1s ease; min-height: 100vh; }
    .mode-weekday { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .mode-weekend { background: linear-gradient(135deg, #ff8a00 0%, #e52e71 100%); }
    .mode-holiday { background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%); }

    .card { 
      background: rgba(255,255,255,0.98); 
      backdrop-filter: blur(16px); 
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(20px);
      opacity: 0;
    }
    .card.visible { transform: translateY(0); opacity: 1; }

    .day-btn {
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform: scale(1) rotate(0deg);
    }
    .day-btn.active {
      transform: scale(1.15) rotate(4deg);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .task-item {
      transition: all 0.4s ease;
      transform: translateX(0);
    }
    .task-item:hover { transform: translateX(8px); }

    .checked { 
      text-decoration: line-through; 
      opacity: 0.5; 
      transform: scale(0.95);
    }

    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.6s ease;
    }

    @keyframes celebrate {
      0%,100% { transform: scale(1) rotate(0); }
      25% { transform: scale(1.3) rotate(-10deg); }
      50% { transform: scale(1.3) rotate(10deg); }
      75% { transform: scale(1.3) rotate(-5deg); }
    }
    .celebrate { animation: celebrate 0.8s ease; }
    
    @keyframes gentle-pulse {
      0%, 100% { 
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1);
      }
      50% { 
        background-color: rgba(147, 197, 253, 0.3);
        transform: scale(1.02);
      }
    }
    .alarm-ringing {
      animation: gentle-pulse 2s infinite !important;
      border-left: 4px solid #3b82f6 !important;
    }
  </style>
</head>
<body class="text-gray-800 mode-weekday">

  <div class="container mx-auto p-6 max-w-5xl">
    <h1 class="text-5xl md:text-6xl font-black text-center text-white mt-12 mb-4 drop-shadow-2xl">
      Daily Bliss Tracker <span id="modeEmoji">Focus Mode</span>
    </h1>
    <p class="text-center text-white text-xl mb-10 font-medium" id="dateToday"></p>

    <!-- Mode Switcher -->
    <div class="flex justify-center gap-6 mb-10 flex-wrap">
      <button onclick="setMode('weekday')"   class="day-btn px-8 py-4 rounded-2xl text-white font-bold text-xl shadow-xl active">
        <span>Weekday</span>
      </button>
      <button onclick="setMode('weekend')"  class="day-btn px-8 py-4 rounded-2xl text-white font-bold text-xl shadow-xl">
        <span>Weekend</span>
      </button>
      <button onclick="setMode('holiday')"  class="day-btn px-8 py-4 rounded-2xl text-white font-bold text-xl shadow-xl">
        <span>Holiday</span>
      </button>
    </div>

    <div id="mainCard" class="card rounded-3xl shadow-2xl p-8 md:p-12">
      <div id="taskList" class="space-y-4"></div>

      <!-- Add Task -->
      <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="newTaskInput" placeholder="What will make today amazing?" 
               class="col-span-1 px-6 py-5 rounded-2xl border-2 border-gray-200 focus:outline-none focus:border-current text-lg"/>
        <input type="time" id="newTaskTime" class="px-6 py-5 rounded-2xl border-2 border-gray-200 text-lg"/>
        <button onclick="addTask()" class="px-10 py-5 rounded-2xl text-white font-bold text-xl shadow-lg hover:shadow-2xl transition">
          <span>Add Task</span>
        </button>
      </div>

      <!-- Stats -->
      <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="text-center p-8 rounded-3xl text-white shadow-2xl">
          <div class="text-5xl font-black" id="todayCompleted">0 / 0</div>
          <p class="mt-3 text-xl opacity-90">Today's Progress</p>
        </div>
        <div class="text-center p-8 rounded-3xl text-white shadow-2xl">
          <div class="text-5xl font-black" id="streakCount">0</div>
          <p class="mt-3 text-3xl">Day Streak</p>
        </div>
        <div class="text-center p-8 rounded-3xl text-white shadow-2xl">
          <div class="text-5xl font-black" id="totalDays">0</div>
          <p class="mt-3 text-xl opacity-90">Days Tracked</p>
        </div>
      </div>

      <div class="text-center mt-12">
        <button onclick="showHistory()" class="text-2xl font-bold underline hover:no-underline transition">
          <span>View Your Beautiful History</span>
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-6">
    <div class="bg-white rounded-3xl shadow-2xl max-w-6xl w-full max-h-screen overflow-y-auto p-10">
      <h2 class="text-5xl font-black text-center mb-10">Your Satisfaction Wall</h2>
      <div id="historyCalendar" class="grid grid-cols-7 gap-4 text-center"></div>
      <div class="text-center mt-12">
        <button onclick="closeHistory()" class="px-12 py-5 bg-gray-800 text-white text-xl rounded-2xl hover:bg-gray-900 transition">
          Close & Keep Shining
        </button>
      </div>
    </div>
  </div>

  <script>
    const data = {
      templates: {
        weekday: ['Wake at 6 AM', 'Exercise 30 min', 'Meditate', 'Deep work block', 'Read 20 pages', 'Plan tomorrow'],
        weekend: ['Sleep in', 'Long breakfast', 'Walk in nature', 'Call family', 'Hobby time', 'Movie night'],
        holiday: ['No alarm', 'Favorite meal', 'Long bath', 'Read for fun', 'Dance party', 'Gratitude journal']
      },
      history: {}
    };

    let currentMode = 'weekday';
    const STORAGE_KEY = 'dailyBlissV4';
    let alarmAudioContext = null;

    // Load saved data
    if (localStorage.getItem(STORAGE_KEY)) {
      Object.assign(data, JSON.parse(localStorage.getItem(STORAGE_KEY)));
    }

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateToday').innerHTML = new Date().toLocaleDateString('en-US', {
      weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
    });

    function setMode(mode) {
      if (currentMode === mode) return;
      
      currentMode = mode;
      document.body.className = `mode-${mode}`;
      
      const emojis = { weekday: 'Focus Mode', weekend: 'Chill Mode', holiday: 'Magic Mode' };
      document.getElementById('modeEmoji').textContent = emojis[mode];
      
      document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      const colors = {
        weekday: 'from-indigo-500 to-purple-600',
        weekend: 'from-orange-500 to-pink-600',
        holiday: 'from-cyan-500 to-purple-600'
      };
      const card = document.getElementById('mainCard');
      card.className = 'card rounded-3xl shadow-2xl p-8 md:p-12 visible';
      
      const stats = document.querySelectorAll('.grid > div');
      stats.forEach((s, i) => {
        s.className = `text-center p-8 rounded-3xl text-white shadow-2xl bg-gradient-to-br ${colors[mode]}`;
      });
      
      const addBtn = document.querySelector('button[onclick="addTask()"]');
      addBtn.className = `px-10 py-5 rounded-2xl text-white font-bold text-xl shadow-lg hover:shadow-2xl transition bg-gradient-to-r ${colors[mode]}`;
      
      loadTasks();
    }

    function parseTask(taskStr) {
      const parts = taskStr.split('|||');
      return { text: parts[0], time: parts[1] || null };
    }

    function formatTask(text, time) {
      return time ? `${text}|||${time}` : text;
    }

    function loadTasks() {
      const list = document.getElementById('taskList');
      list.innerHTML = '';
      const rawTasks = data.templates[currentMode] || [];
      const key = `${today}_${currentMode}`;
      const done = data.history[key] || [];

      rawTasks.forEach((rawTask, i) => {
        const { text, time } = parseTask(rawTask);
        const checked = done[i] || false;

        const item = document.createElement('div');
        item.className = 'task-item flex flex-col gap-3 bg-gray-50 p-6 rounded-2xl shadow-md';
        item.id = `task-${i}`;

        const progressHTML = time ? `
          <div class="progress-bar">
            <div class="progress-fill" id="progress-${i}"></div>
          </div>
          <div class="text-sm text-gray-600 text-right" id="timeLabel-${i}"></div>
        ` : '';

        item.innerHTML = `
          <div class="flex items-center gap-5">
            <input type="checkbox" ${checked?'checked':''} onchange="toggle(${i})" 
                   class="w-8 h-8 rounded-full focus:ring-4 focus:ring-current"/>
            <span class="text-xl flex-1 ${checked?'checked':''}">${text}</span>
            ${time ? `<span class="text-lg font-medium text-indigo-600">${time}</span>` : ''}
            <button onclick="removeTask(${i})" class="text-gray-400 hover:text-red-600 text-2xl cursor-pointer transition">
              <span>Remove</span>
            </button>
          </div>
          ${progressHTML}
        `;
        list.appendChild(item);

        if (time && !checked) {
          startCountdown(i, time);
        }
      });
      updateStats();
    }

    function startCountdown(index, timeStr) {
      const update = () => {
        const now = new Date();
        const [hours, minutes] = timeStr.split(':').map(Number);
        const target = new Date();
        target.setHours(hours, minutes, 0, 0);

        // Check if target time has passed today
        if (now >= target) {
          triggerAlarm(index);
          return;
        }

        const diffMs = target - now;
        const totalMinutes = diffMs / 60000;
        const percent = Math.max(0, Math.min(100, (1 - totalMinutes / (24*60)) * 100));

        const prog = document.getElementById(`progress-${index}`);
        const label = document.getElementById(`timeLabel-${index}`);
        if (prog) prog.style.width = percent + '%';

        const hrs = Math.floor(totalMinutes / 60);
        const mins = Math.floor(totalMinutes % 60);
        if (label) label.textContent = hrs ? `${hrs}h ${mins}m left` : `${mins}m left`;
      };

      update();
      const interval = setInterval(update, 60000); // update every minute
      // Store interval ID so we can clear it when task is completed
      if (!window.alarmIntervals) window.alarmIntervals = [];
      window.alarmIntervals[index] = interval;
    }

    function playGentleAlarm() {
      try {
        if (!alarmAudioContext) {
          alarmAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        const now = alarmAudioContext.currentTime;
        const oscillator = alarmAudioContext.createOscillator();
        const gainNode = alarmAudioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(alarmAudioContext.destination);
        
        // Gentle wind chime-like sound
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, now); // C5
        oscillator.frequency.setValueAtTime(659.25, now + 0.3); // E5
        oscillator.frequency.setValueAtTime(783.99, now + 0.6); // G5
        
        // Soft fade in and out
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.2, now + 0.1);
        gainNode.gain.linearRampToValueAtTime(0.2, now + 0.8);
        gainNode.gain.linearRampToValueAtTime(0, now + 1.0);
        
        oscillator.start(now);
        oscillator.stop(now + 1.0);
        
        // Repeat after a pleasant delay
        setTimeout(() => {
          if (window.ringingTasks && window.ringingTasks.size > 0) {
            playGentleAlarm();
          }
        }, 3000); // Repeat every 3 seconds instead of being constant
      } catch (error) {
        console.log('Audio error:', error);
      }
    }

    function triggerAlarm(index) {
      // Store that this task is ringing
      if (!window.ringingTasks) window.ringingTasks = new Set();
      window.ringingTasks.add(index);

      // Visual alert - much gentler now
      const item = document.getElementById(`task-${index}`);
      if (item) {
        item.classList.add('alarm-ringing');
      }

      // Play gentle sound
      playGentleAlarm();

      // Browser notification if available
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Daily Bliss Tracker', {
          body: `Time for: ${parseTask(data.templates[currentMode][index]).text}`,
          icon: '/favicon.ico'
        });
      }
    }

    function stopAlarmIfRinging(index) {
      if (window.ringingTasks && window.ringingTasks.has(index)) {
        window.ringingTasks.delete(index);
        
        // Stop visual alert
        const item = document.getElementById(`task-${index}`);
        if (item) {
          item.classList.remove('alarm-ringing');
        }
      }
      // Clear countdown interval
      if (window.alarmIntervals && window.alarmIntervals[index]) {
        clearInterval(window.alarmIntervals[index]);
      }
    }

    function toggle(i) {
      const key = `${today}_${currentMode}`;
      if (!data.history[key]) data.history[key] = [];
      data.history[key][i] = !data.history[key][i];
      
      stopAlarmIfRinging(i); // Stops ringing when checked
      save();
      loadTasks();
      if (data.history[key].filter(x=>x).length === data.templates[currentMode].length) {
        document.getElementById('mainCard').classList.add('celebrate');
        setTimeout(()=>document.getElementById('mainCard').classList.remove('celebrate'), 1000);
      }
    }

    function addTask() {
      const input = document.getElementById('newTaskInput');
      const timeInput = document.getElementById('newTaskTime');
      const text = input.value.trim();
      const time = timeInput.value || null;
      if (text) {
        const formatted = formatTask(text, time);
        data.templates[currentMode].push(formatted);
        input.value = '';
        timeInput.value = '';
        save();
        loadTasks();
      }
    }

    function removeTask(i) {
      stopAlarmIfRinging(i);
      data.templates[currentMode].splice(i, 1);
      const key = `${today}_${currentMode}`;
      if (data.history[key]) data.history[key].splice(i, 1);
      save();
      loadTasks();
    }

    function updateStats() {
      const key = `${today}_${currentMode}`;
      const done = (data.history[key]||[]).filter(x=>x).length;
      const total = data.templates[currentMode].length;
      document.getElementById('todayCompleted').textContent = `${done} / ${total}`;

      // Streak logic
      let streak = 0;
      let checkDate = new Date();
      for (let i = 0; i < 365; i++) {
        const d = checkDate.toISOString().split('T')[0];
        const isWeekend = checkDate.getDay() === 0 || checkDate.getDay() === 6;
        const mode = isWeekend ? 'weekend' : 'weekday';
        const k = `${d}_${mode}`;
        const hist = data.history[k];
        if (hist && hist.filter(x=>x).length === data.templates[mode].length && hist.length > 0) {
          streak++;
        } else if (i > 0) break;
        checkDate.setDate(checkDate.getDate() - 1);
      }
      document.getElementById('streakCount').textContent = streak;
      document.getElementById('totalDays').textContent = Object.keys(data.history).filter(k=>data.history[k].length>0).length;
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function showHistory() {
      const cal = document.getElementById('historyCalendar');
      cal.innerHTML = '';
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      days.forEach(d=> {
        const h = document.createElement('div');
        h.className = 'font-bold text-gray-600';
        h.textContent = d;
        cal.appendChild(h);
      });

      // Fixed calendar alignment
      const today = new Date();
      const start = new Date(today);
      start.setDate(today.getDate() - 90);
      
      // Find the most recent Sunday for proper alignment
      while (start.getDay() !== 0) {
        start.setDate(start.getDate() - 1);
      }

      // Now fill the calendar starting from that Sunday
      for (let i = 0; i < 98; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        const day = d.getDay();
        const isWeekend = day===0 || day===6;
        const mode = isWeekend ? 'weekend' : 'weekday';
        const key = `${dateStr}_${mode}`;
        const hist = data.history[key];
        const rawTasks = data.templates[mode] || [];
        const total = rawTasks.length;
        const done = hist ? hist.filter(x=>x).length : 0;
        const pct = total > 0 ? Math.round(done/total*100) : 0;

        const cell = document.createElement('div');
        cell.className = 'aspect-square flex flex-col items-center justify-center rounded-2xl text-white font-bold text-lg shadow-lg';
        
        if (pct === 100 && total > 0) {
          cell.className += ' bg-gradient-to-br from-green-500 to-emerald-600 text-3xl';
          cell.innerHTML = `<span>100%</span><span class="text-4xl mt-1">Perfect</span>`;
        } else if (pct >= 70) {
          cell.className += ' bg-gradient-to-br from-yellow-500 to-orange-600';
          cell.textContent = `${pct}%`;
        } else if (pct > 0) {
          cell.className += ' bg-gradient-to-br from-red-500 to-pink-600';
          cell.textContent = `${pct}%`;
        } else {
          cell.className = 'bg-gray-200 text-gray-400';
          cell.textContent = dateStr.slice(8);
        }
        cal.appendChild(cell);
      }
      document.getElementById('historyModal').classList.remove('hidden');
    }

    function closeHistory() {
      document.getElementById('historyModal').classList.add('hidden');
    }

    // Request notification permission on load
    if ('Notification' in window) {
      Notification.requestPermission();
    }

    // Init
    const todayDay = new Date().getDay();
    const autoMode = (todayDay === 0 || todayDay === 6) ? 'weekend' : 'weekday';
    setMode(autoMode || 'weekday');
  </script>
</body>
</html>
